<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GeoQuest: North America Trek ‚Äî v2.3.4 (Assessed Events)</title>
<style>
  :root{ --bg:#0e1726;--panel:#121d31;--accent:#4cc9f0;--accent2:#f72585;--good:#2dd36f;--warn:#ffd166;--bad:#ef476f;--ink:#e6edf7;--muted:#93a3b8;--card:#0f223a; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 10% 10%, #17263f, var(--bg));color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;di[...]
  #journeyPane,#uiPane{background:var(--panel);border:1px solid #1f2e4a;border-radius:16px;overflow:hidden;position:relative}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(15,34,58,.95), rgba(15,34,58,.7));padding:10px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid #2[...]
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1d33;border:1px solid #203250;color:var(--muted);font-weight:600}
  .badge b{color:var(--ink)}
  .pill{border:1px solid #2b3e66;background:#0f1d33;color:var(--ink);padding:7px 12px;border-radius:999px;cursor:pointer}
  .pill[disabled]{opacity:.5;cursor:not-allowed}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #2b3e66;background:#0f223a;color:#fff;cursor:pointer;font-weight:600}
  .btn:hover{border-color:#3e5d95}
  .btn.primary{background:linear-gradient(180deg, #1b345a, #122747);border-color:#35558d}
  .btn.good{background:#0e2b20;border-color:#1d5e45}
  .btn.warn{background:#2e2811;border-color:#6f5a1d}
  .section{padding:14px}
  #uiPane{display:flex;flex-direction:column}
  #log{flex:1;overflow:auto;padding:10px 14px}
  #controls{padding:12px 14px;border-top:1px solid #203250;display:flex;flex-wrap:wrap;gap:8px}
  .card{background:var(--card);border:1px solid #21365d;border-radius:14px;padding:12px;margin:10px 0}
  .card h3{margin:0 0 6px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row .col{flex:1 1 220px}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
  .kv div:nth-child(odd){color:var(--muted)}
  .small{font-size:.95rem;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}

  /* Journey UI */
  #journeyWrap{height:100%;display:flex;flex-direction:column}
  #journey{flex:1;overflow:auto;padding:12px 14px}
  .destGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
  .chip{display:flex;align-items:center;gap:8px;border:1px solid #2b3e66;background:#0f1d33;color:var(--ink);padding:10px;border-radius:12px;cursor:pointer}
  .chip[disabled]{opacity:.55;cursor:not-allowed}
  .list{display:flex;flex-wrap:wrap;gap:8px}
  .stamp{display:inline-flex;align-items:center;gap:6px;background:rgba(76,201,240,.12);color:#bfe9fb;border:1px dashed #4cc9f0;padding:4px 8px;border-radius:999px;font-weight:700}
  .vcard{display:flex;gap:10px;align-items:center;background:#0f223a;border:1px solid #21365d;border-radius:10px;padding:8px;margin:8px 0}
  .vcard .emoji{font-size:1.4rem}

  /* Pixel art images */
  .pimg{width:72px;height:72px;image-rendering:pixelated;border-radius:8px;border:1px solid #21365d;background:#071325;display:block}
  .chip .pimg{width:40px;height:40px;border-radius:6px}

  /* Modal */
  dialog{border:none;border-radius:16px;padding:0;color:var(--ink);background:#0e1b30;max-width:min(820px,92vw)}
  dialog::backdrop{background:rgba(0,10,20,.66)}
  .modal{padding:16px}
  .modal header{position:static;background:transparent;border:0;padding:0 0 10px 0}
  .choices{display:grid;gap:8px;margin-top:10px}
  .choice{padding:10px 12px;border:1px solid #2b3e66;border-radius:12px;background:#0a1730;cursor:pointer}
  .choice:hover{border-color:#4c6fb1}
  .choice.correct{border-color:#1f7a55;background:#0e2b20}
  .choice.wrong{border-color:#7a1f37;background:#3a0f1a}

  /* Fallback modal */
  .overlay{position:fixed;inset:0;background:rgba(0,10,20,.66);display:none;align-items:center;justify-content:center;z-index:9999}
  .overlay .sheet{background:#0e1b30;border-radius:16px;max-width:min(820px,92vw);padding:16px;border:1px solid #21365d}

  /* === Pixel Map === */
  #mapWrap{position:relative;border:1px solid #21365d;border-radius:12px;background:#071325;overflow:hidden;margin-bottom:14px}
  #mapCanvas{width:100%;height:360px;image-rendering:pixelated;display:block}
  #mapTip{position:absolute;pointer-events:none;background:#0f223a;border:1px solid #21365d;padding:4px 6px;border-radius:8px;color:var(--ink);font-size:12px;display:none;white-space:nowrap;z-index:10}
  .mapLegend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;margin-top:8px}
  .mapLegend .swatch{width:12px;height:12px;border-radius:3px;border:1px solid #21365d;display:inline-block}

  @media (max-width: 1100px){ body{grid-template-columns:1fr;grid-auto-rows:auto auto} }
</style>
</head>
<body>

  <!-- === PIXEL MAP UI (NEW) === -->
  <div id="mapWrap">
    <canvas id="mapCanvas" width="740" height="360"></canvas>
    <div id="mapTip"></div>
    <div class="mapLegend">
      <span>Legend:</span>
      <span class="swatch" style="background:#ffd166"></span> USA
      <span class="swatch" style="background:#4cc9f0"></span> CAN
      <span class="swatch" style="background:#f72585"></span> MEX
    </div>
  </div>

  <section id="journeyPane" aria-label="Journey">
    <div id="journeyHeader">
      <div class="badge">GeoQuest: <b>North America Trek</b></div>
      <div class="badge">Student: <b id="hudName">‚Äî</b></div>
      <div class="badge">Knowledge ‚≠ê <b id="hudXP">0</b></div>
      <div class="badge">Travel üö∂ <b id="hudAP">0</b></div>
      <div class="badge">Visits üìç <b id="hudVisits">0</b></div>
      <div class="badge">Time ‚è±Ô∏è <b id="hudTime">00:00</b></div>
    </div>
    <div id="journeyWrap">
      <div id="journey"></div>
    </div>
  </section>

  <section id="uiPane" aria-label="Game interface">
    <header>
      <div class="badge">Class: <b id="hudClass">‚Äî</b></div>
      <div class="badge">Goal: <b>Earn 20 Knowledge ‚≠ê and visit 12 locations.</b></div>
      <div style="margin-left:auto" class="row">
        <button class="pill" id="btnLearn" aria-haspopup="dialog" type="button">Reference</button>
        <button class="pill" id="btnSave" type="button">Save</button>
        <button class="pill" id="btnReset" type="button">Reset</button>
      </div>
    </header>
    <div id="log" aria-live="polite"></div>
    <div id="controls">
      <button id="btnStart" class="btn primary" type="button">Start / Continue</button>
      <button id="btnQuiz" class="btn" type="button">Practice Quiz</button>
      <button id="btnEvent" class="btn" type="button">Explore Event</button>
      <button id="btnFinish" class="btn good" type="button">Finish &amp; Get Code</button>
      <button id="btnVerify" class="btn warn" type="button">Verify Code (Teacher)</button>
      <button id="btnExport" class="btn" type="button">Export Save</button>
      <button id="btnImport" class="btn" type="button">Import Save</button>
    </div>
  </section>

  <dialog id="modal" aria-modal="true"></dialog>
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true"><div class="sheet" id="overlaySheet"></div></div>

<script>
/***************************
 * GeoQuest: North America Trek ‚Äî v2.3.4 (Assessed Events)
 * (existing main game script omitted for brevity in this snippet)
 * ...all your existing code remains here, unchanged...
 ***************************/

/********* PIXEL MAP (Interactive) *********/
const COUNTRY_COL = { USA:'#ffd166', CAN:'#4cc9f0', MEX:'#f72585' };
const EDGE_COL = '#2b3e66';
const HILITE_EDGE_COL = '#5ea1ff';
const CURRENT_RING = '#ffffff';
const NEIGH_RING = '#8ee3ff';
const MAP_BG_WATER = '#081a2f';
const MAP_LAND = '#0f2640';
const MAP_GRID = 'rgba(255,255,255,.05)';

const CITY_POS = {
  van:[0.10,0.32], vic:[0.08,0.34], calg:[0.17,0.30], edm:[0.18,0.26], winn:[0.32,0.34],
  tor:[0.52,0.46], ott:[0.54,0.44], mont:[0.57,0.43], que:[0.60,0.40], hal:[0.68,0.46], stj:[0.76,0.38],
  sea:[0.12,0.36], por:[0.14,0.40], sf:[0.18,0.54], la:[0.20,0.60], sd:[0.21,0.64],
  phx:[0.25,0.62], slc:[0.24,0.52], den:[0.30,0.50], dal:[0.39,0.67], hou:[0.42,0.72], sa:[0.40,0.74], no:[0.48,0.74],
  minn:[0.36,0.46], chi:[0.44,0.50], det:[0.49,0.48], atl:[0.56,0.64], mia:[0.60,0.78],
  nyc:[0.60,0.50], bos:[0.63,0.48], dc:[0.58,0.54], clt:[0.56,0.58], nash:[0.52,0.58], phl:[0.59,0.52],
  tij:[0.23,0.68], herm:[0.29,0.65], gdl:[0.36,0.79], cdmx:[0.40,0.82], pue:[0.42,0.83], oax:[0.46,0.88],
  mty:[0.43,0.71], coa:[0.41,0.69], ver:[0.49,0.82], mer:[0.58,0.84], cun:[0.62,0.84]
};

const LAND_POLY = [
  [0.05,0.28],[0.14,0.22],[0.24,0.22],[0.36,0.20],[0.55,0.24],[0.70,0.28],
  [0.82,0.36],[0.90,0.44],[0.93,0.52],[0.86,0.58],[0.78,0.54],[0.71,0.59],
  [0.66,0.66],[0.61,0.74],[0.54,0.80],[0.46,0.84],[0.38,0.82],[0.30,0.78],
  [0.25,0.73],[0.20,0.66],[0.15,0.58],[0.11,0.50],[0.08,0.40]
];

function neighborsOf(id){
  return EDGES.filter(([a,b])=>a===id||b===id).map(([a,b])=>a===id?b:a);
}

function drawMap(){
  const canvas = document.getElementById('mapCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // Background
  ctx.fillStyle = MAP_BG_WATER;
  ctx.fillRect(0,0,W,H);

  // Land polygon
  ctx.beginPath();
  LAND_POLY.forEach(([x,y],i)=>{
    ctx[i?'lineTo':'moveTo'](x*W,y*H);
  });
  ctx.closePath();
  ctx.fillStyle = MAP_LAND;
  ctx.fill();

  // Grid overlay
  for(let x=0;x<W;x+=40){
    ctx.strokeStyle = MAP_GRID;
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
  }
  for(let y=0;y<H;y+=40){
    ctx.strokeStyle = MAP_GRID;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
  }

  // Edges
  EDGES.forEach(([a,b])=>{
    const pa = CITY_POS[a], pb = CITY_POS[b];
    if(!pa||!pb) return;
    ctx.strokeStyle = EDGE_COL;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(pa[0]*W, pa[1]*H);
    ctx.lineTo(pb[0]*W, pb[1]*H);
    ctx.stroke();
  });

  // Highlight current and neighbors
  const curId = State.current;
  const neighIds = neighborsOf(curId);

  // Highlighted edges
  EDGES.forEach(([a,b])=>{
    if((a===curId&&neighIds.includes(b))||(b===curId&&neighIds.includes(a))){
      const pa = CITY_POS[a], pb = CITY_POS[b];
      ctx.strokeStyle = HILITE_EDGE_COL;
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(pa[0]*W, pa[1]*H);
      ctx.lineTo(pb[0]*W, pb[1]*H);
      ctx.stroke();
    }
  });

  // Cities
  CITIES.forEach(city=>{
    const [x,y] = CITY_POS[city.id]||[0,0];
    const px = x*W, py = y*H;
    // Node
    ctx.beginPath();
    ctx.arc(px,py,9,0,Math.PI*2);
    ctx.fillStyle = COUNTRY_COL[city.country]||'#fff';
    ctx.globalAlpha = 0.9;
    ctx.fill();
    ctx.globalAlpha = 1.0;
    ctx.strokeStyle = "#21365d";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Current location ring
    if(city.id===curId){
      ctx.beginPath();
      ctx.arc(px,py,13,0,Math.PI*2);
      ctx.strokeStyle = CURRENT_RING;
      ctx.lineWidth = 3;
      ctx.stroke();
    }
    // Neighbor highlight
    else if(neighIds.includes(city.id)){
      ctx.beginPath();
      ctx.arc(px,py,13,0,Math.PI*2);
      ctx.strokeStyle = NEIGH_RING;
      ctx.lineWidth = 2;
      ctx.stroke();
    }
  });
}

function mapCityAt(mx,my){
  // Returns city id at pixel (mx,my), or null
  const canvas = document.getElementById('mapCanvas');
  if(!canvas) return null;
  const W = canvas.width, H = canvas.height;
  for(const city of CITIES){
    const [x,y] = CITY_POS[city.id]||[0,0];
    const px = x*W, py = y*H;
    const d2 = (mx-px)*(mx-px)+(my-py)*(my-py);
    if(d2<=100) return city; // radius ~10px
  }
  return null;
}

function setupMap(){
  const canvas = document.getElementById('mapCanvas');
  const mapTip = document.getElementById('mapTip');
  if(!canvas || !mapTip) return;

  function showTip(msg,x,y){
    mapTip.textContent = msg;
    mapTip.style.display = 'block';
    mapTip.style.left = `${x+16}px`;
    mapTip.style.top = `${y+8}px`;
  }
  function hideTip(){ mapTip.style.display = 'none'; }

  canvas.addEventListener('mousemove', e=>{
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX-rect.left)*canvas.width/rect.width;
    const my = (e.clientY-rect.top)*canvas.height/rect.height;
    const city = mapCityAt(mx,my);
    if(city){
      showTip(`${city.name} (${city.country})`, e.clientX-rect.left, e.clientY-rect.top);
      canvas.style.cursor = 'pointer';
    }else{
      hideTip();
      canvas.style.cursor = 'default';
    }
  });
  canvas.addEventListener('mouseleave', hideTip);

  canvas.addEventListener('click', e=>{
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX-rect.left)*canvas.width/rect.width;
    const my = (e.clientY-rect.top)*canvas.height/rect.height;
    const city = mapCityAt(mx,my);
    if(city && (city.id===State.current || neighborsOf(State.current).includes(city.id))){
      onCityClick(city);
    }
  });
}

function renderAllWithMap(){
  _origRenderAll(); // call the original renderAll for UI
  drawMap();
}
const _origRenderAll = renderAll;
renderAll = renderAllWithMap;

document.addEventListener('DOMContentLoaded', ()=>{
  setupMap();
  drawMap();
});
</script>
</body>
</html>
